<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bancada de Testes da API</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 900px; margin: auto; background-color: #f4f7f9; }
        h1, h2, h3 { color: #333; }
        fieldset { border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; padding: 20px; background-color: white; }
        legend { font-weight: bold; font-size: 1.2em; padding: 0 10px; color: #007bff; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], textarea { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        textarea { height: 150px; font-family: monospace; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; padding: 12px 18px; border-radius: 4px; font-size: 1em; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #log { background-color: #2d333b; color: #adbac7; border-radius: 4px; padding: 15px; white-space: pre-wrap; font-family: monospace; min-height: 100px; }
        .state-display { display: flex; gap: 20px; margin-bottom: 20px; }
        .state-display div { flex: 1; }
        .state-display input { background-color: #e9ecef; }
        .input-mode { margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Bancada de Testes da API</h1>

    <fieldset>
        <legend>Estado Atual</legend>
        <div class="state-display">
            <div>
                <label for="standbyToken">Token de Standby</label>
                <input type="text" id="standbyToken" readonly>
            </div>
            <div>
                <label for="loginToken">Token de Login</label>
                <input type="text" id="loginToken" readonly>
            </div>
            <div>
                <label for="userId">ID do Usuário Criado</label>
                <input type="text" id="userId" readonly>
            </div>
            <div>
                <label for="validationLink">Link de Validação (Apenas para Teste)</label>
                <input type="text" id="validationLink" readonly>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>Fase 1 & 2: Cadastrar Usuário</legend>
        <div class="input-mode">
            <label><input type="radio" name="inputMode" value="form" checked onchange="toggleInputMode()"> Formulário</label>
            <label><input type="radio" name="inputMode" value="json" onchange="toggleInputMode()"> JSON Bruto</label>
        </div>
        <div id="formContainer">
            <label for="nomeCompleto">Nome Completo</label>
            <input type="text" id="nomeCompleto" value="Joana D'Arc Programadora">
            <label for="email">E-mail</label>
            <input type="email" id="email" value="joana.dev@email.com">
            <label for="senha">Senha</label>
            <input type="password" id="senha" value="senha_super_segura_123">
            <label for="telefoneCelular">Telefone Celular</label>
            <input type="text" id="telefoneCelular" value="51911112222">
            <label for="dataNascimento">Data de Nascimento (Opcional)</label>
            <input type="date" id="dataNascimento" value=""> <label for="cpf">CPF (opcional)</label>
            <input type="text" id="cpf" value="12345678901">
        </div>
        <div id="jsonContainer" style="display: none;">
            <textarea id="jsonInput"></textarea>
        </div>
        <button onclick="iniciarCadastro()">1. Obter Token de Standby</button>
        <button onclick="cadastrarUsuario()" id="btnCadastrar">2. Cadastrar Usuário</button>
    </fieldset>

    <fieldset>
        <legend>Fase 3, 4 & 5: Permissões e Ativação</legend>
        <button onclick="testarPermissaoFalha()" id="btnFalha">3. Testar Permissão (Deve Falhar se PENDENTE)</button>
        <button onclick="validarContaPelaAPI()" id="btnValidarConta">4. Validar Conta Via API</button>
        <button onclick="testarPermissaoSucesso()" id="btnSucesso">5. Testar Permissão (Deve Funcionar)</button>
    </fieldset>

    <fieldset>
        <legend>Teste de Atualização de CPF (Foco no 404)</legend>
        <label for="cpfAtualizacao">Novo CPF para Atualização</label>
        <input type="text" id="cpfAtualizacao" value="12345678901">
        <button onclick="atualizarCpfUsuario()">Atualizar CPF (PATCH)</button>
    </fieldset>

    <fieldset>
        <legend>Log de Respostas</legend>
        <pre id="log">Aguardando ações...</pre>
    </fieldset>

    <script>
        // ATENÇÃO: Ajuste a URL da API se o seu servidor estiver em um endereço diferente ou porta diferente
        const API_URL = 'http://localhost:3333/api/v1'; 
        let state = {
            standbyToken: null,
            loginToken: null,
            userId: null,
            validationLink: null // Para armazenar o link de validação
        };
        const templates = {
            pessoa: {
                nomeCompleto: "Joana D'Arc Programadora",
                email: "joana.dev@email.com",
                senha: "senha_super_segura_123",
                telefoneCelular: "51911112222",
                dataNascimento: "", // Opcional
                cpf: "12345678901" // Opcional
            },
            animal: {
                nome: "Bit",
                apelido: "Byte",
                especie: "Cão",
                raca: "Vira-lata Caramelo",
                sexo: "Macho",
                dataNascimento: "2023-01-01",
                cor: "Caramelo"
            }
        };

        const logEl = document.getElementById('log');
        const standbyTokenEl = document.getElementById('standbyToken');
        const loginTokenEl = document.getElementById('loginToken');
        const userIdEl = document.getElementById('userId');
        const validationLinkEl = document.getElementById('validationLink');

        function log(message) {
            logEl.textContent = JSON.stringify(message, null, 2);
            console.log(message);
        }

        function updateStateUI() {
            standbyTokenEl.value = state.standbyToken || '';
            loginTokenEl.value = state.loginToken || '';
            userIdEl.value = state.userId || '';
            validationLinkEl.value = state.validationLink || '';
        }

        function toggleInputMode() {
            const isForm = document.querySelector('input[name="inputMode"]:checked').value === 'form';
            document.getElementById('formContainer').style.display = isForm ? 'block' : 'none';
            document.getElementById('jsonContainer').style.display = isForm ? 'none' : 'block';
            if (!isForm) {
                document.getElementById('jsonInput').value = JSON.stringify(templates.pessoa, null, 2);
            }
        }

        async function apiCall(endpoint, method, token = null, body = null, isRawLink = false) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const options = {
                method: method,
                headers: headers
            };
            if (body) {
                options.body = JSON.stringify(body);
            }

            const url = isRawLink ? endpoint : `${API_URL}${endpoint}`;

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                log({ status: response.status, ok: response.ok, body: data });
                return { status: response.status, ok: response.ok, data: data };
            } catch (error) {
                log({ status: 'Network Error ou JSON inválido', message: error.message });
                return { status: 500, ok: false, data: { message: error.message } };
            }
        }

        async function iniciarCadastro() {
            log("Iniciando cadastro para obter Token de Standby...");
            const result = await apiCall('/auth/iniciar-cadastro', 'POST');
            if (result.ok) {
                state.standbyToken = result.data.standby_token;
                updateStateUI();
                log("Token de Standby obtido com sucesso.");
            } else {
                log("Falha ao obter Token de Standby.");
            }
        }

        async function cadastrarUsuario() {
            if (!state.standbyToken) {
                log({ error: 'Primeiro, obtenha o Token de Standby clicando no botão "1. Obter Token de Standby".' });
                return;
            }
            const isForm = document.querySelector('input[name="inputMode"]:checked').value === 'form';
            let dadosUsuario;
            if (isForm) {
                dadosUsuario = {
                    nomeCompleto: document.getElementById('nomeCompleto').value,
                    email: document.getElementById('email').value,
                    senha: document.getElementById('senha').value,
                    telefoneCelular: document.getElementById('telefoneCelular').value,
                    // Garante que dataNascimento seja null se estiver vazio
                    dataNascimento: document.getElementById('dataNascimento').value || null,
                    // Garante que cpf seja null se estiver vazio
                    cpf: document.getElementById('cpf').value || null 
                };
            } else {
                try {
                    dadosUsuario = JSON.parse(document.getElementById('jsonInput').value);
                } catch(e) {
                    log({ error: 'JSON inválido!', details: e.message });
                    return;
                }
            }
            log("Cadastrando usuário com Token de Standby...");
            // A rota de cadastro não precisa do standbyToken no header se ele for validado no corpo ou em outro middleware
            // No entanto, se seu backend espera um header Authorization com Bearer standby_token, descomente a linha abaixo
            const result = await apiCall('/pessoas', 'POST', state.standbyToken, dadosUsuario); 
            // const result = await apiCall('/pessoas', 'POST', null, dadosUsuario); // Se o standbyToken não for via Authorization header

            if (result.ok) {
                // Se a API de cadastro já retornar um token de login, armazene-o
                state.loginToken = result.data.token || null; 
                state.userId = result.data.pessoa.id; // Supondo que a resposta inclua 'pessoa.id'
                state.validationLink = result.data.linkValidacaoParaTeste; // Supondo que a resposta inclua o link
                updateStateUI();
                log("Usuário cadastrado com sucesso! Verifique o link de validação.");
            } else {
                log("Falha ao cadastrar usuário.");
            }
        }

        async function testarPermissaoFalha() {
            if (!state.loginToken) {
                log({ error: 'Cadastre um usuário e obtenha o Token de Login primeiro.'});
                return;
            }
            log("Tentando criar animal com token de usuário PENDENTE. Esperando erro 403 (ou similar)...");
            // Nota: O método POST /animais pode retornar 403 se o usuário PENDENTE não tiver permissão.
            // Ajuste o corpo da requisição 'templates.animal' se seu endpoint de animais espera dados diferentes.
            await apiCall('/animais', 'POST', state.loginToken, templates.animal);
        }

        async function validarContaPelaAPI() {
            if (!state.validationLink) {
                log({ error: 'Cadastre um usuário primeiro para obter o link de validação.' });
                return;
            }
            log(`Validando conta usando o link: ${state.validationLink}`);
            // Chamando o link de validação diretamente (GET ou POST, dependendo da sua API)
            // Assumindo que seu endpoint de validação é um GET e usa o token da URL
            const result = await apiCall(state.validationLink, 'GET', null, null, true); // true indica que é uma URL completa
            // Ou se for um POST para um endpoint específico (ex: /validar-conta) e o token for no corpo:
            // const tokenParam = new URLSearchParams(state.validationLink.split('?')[1]).get('token');
            // const result = await apiCall('/validar-conta', 'POST', null, { token: tokenParam });

            if (result.ok) {
                log("Conta validada com sucesso! Tente testar as permissões novamente.");
                // Opcional: Atualize o status da conta do usuário no UI, se a resposta der o status
                // state.loginToken pode precisar ser atualizado ou um novo login feito para refletir o status ATIVO_BASICO
            } else {
                log("Falha ao validar conta.");
            }
        }

        async function testarPermissaoSucesso() {
            if (!state.loginToken) {
                log({ error: 'Cadastre e valide um usuário para obter o Token de Login e permissões.'});
                return;
            }
            log("Tentando criar animal com token de usuário ATIVO. Esperando sucesso 201...");
            // Este teste deve funcionar após a conta ser ativada e o token de login ter as permissões corretas.
            await apiCall('/animais', 'POST', state.loginToken, templates.animal);
        }

        async function atualizarCpfUsuario() {
            if (!state.loginToken || !state.userId) {
                log({ error: 'Cadastre e logue um usuário para atualizar o CPF.' });
                return;
            }
            const cpfParaAtualizar = document.getElementById('cpfAtualizacao').value;

            // O PessoaController.atualizarCpf espera 'email' e 'cpf' no corpo da requisição, não ID.
            // Precisamos do email do usuário logado para enviar.
            const userEmail = document.getElementById('email').value; // Usamos o email do formulário de cadastro

            if (!userEmail) {
                log({ error: 'Email do usuário não disponível no formulário de cadastro para atualização de CPF.' });
                return;
            }

            const body = { email: userEmail, cpf: cpfParaAtualizar };

            log(`Tentando atualizar CPF do usuário ${userEmail} para ${cpfParaAtualizar} via PATCH /pessoas/cpf...`);
            // Esta rota requer autenticação, então passamos o loginToken
            await apiCall(`/pessoas/cpf`, 'PATCH', state.loginToken, body);
        }


        // Inicializa a UI
        toggleInputMode();
        updateStateUI(); // Garante que os campos de estado estejam vazios ao carregar
    </script>
</body>
</html>