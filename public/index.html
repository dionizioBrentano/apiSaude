<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bancada de Testes da API</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 900px; margin: auto; background-color: #f4f7f9; }
        h1, h2, h3 { color: #333; }
        fieldset { border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; padding: 20px; background-color: white; }
        legend { font-weight: bold; font-size: 1.2em; padding: 0 10px; color: #007bff; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], textarea { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        textarea { height: 150px; font-family: monospace; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; padding: 12px 18px; border-radius: 4px; font-size: 1em; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #log { background-color: #2d333b; color: #adbac7; border-radius: 4px; padding: 15px; white-space: pre-wrap; font-family: monospace; min-height: 100px; }
        .state-display { display: flex; gap: 20px; margin-bottom: 20px; }
        .state-display div { flex: 1; }
        .state-display input { background-color: #e9ecef; }
        .input-mode { margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Bancada de Testes da API</h1>

    <fieldset>
        <legend>Estado Atual</legend>
        <div class="state-display">
            <div>
                <label for="standbyToken">Token de Standby</label>
                <input type="text" id="standbyToken" readonly>
            </div>
            <div>
                <label for="loginToken">Token de Login</label>
                <input type="text" id="loginToken" readonly>
            </div>
            <div>
                <label for="userId">ID do Usuário Criado</label>
                <input type="text" id="userId" readonly>
            </div>
             <div>
                <label for="orgId">ID da Org. Raiz Criada</label>
                <input type="text" id="orgId" readonly>
            </div>
            <div>
                <label for="validationLink">Link de Validação (Apenas para Teste)</label>
                <input type="text" id="validationLink" readonly>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>Fase 1 & 2: Cadastrar Usuário e Validação</legend>
        <div class="input-mode">
            <label><input type="radio" name="inputMode" value="form" checked onchange="toggleInputMode()"> Formulário</label>
            <label><input type="radio" name="inputMode" value="json" onchange="toggleInputMode()"> JSON Bruto</label>
        </div>
        <div id="formContainer">
            <label for="nomeCompleto">Nome Completo</label>
            <input type="text" id="nomeCompleto" value="Joana D'Arc Programadora">
            <label for="email">E-mail</label>
            <input type="email" id="email" value="joana.dev@email.com">
            <label for="senha">Senha</label>
            <input type="password" id="senha" value="senha_super_segura_123">
            <label for="telefoneCelular">Telefone Celular</label>
            <input type="text" id="telefoneCelular" value="51911112222">
            <label for="dataNascimento">Data de Nascimento (Opcional)</label>
            <input type="date" id="dataNascimento" value=""> 
            <label for="cpf">CPF (opcional)</label>
            <input type="text" id="cpf" value="12345678901">
            <button onclick="generateRandomData()">Gerar Dados Aleatórios</button>
        </div>
        <div id="jsonContainer" style="display: none;">
            <textarea id="jsonInput"></textarea>
        </div>
        <button onclick="iniciarCadastro()">1. Obter Token de Standby</button>
        <button onclick="cadastrarUsuario()" id="btnCadastrar">2. Cadastrar Usuário</button>
        <button onclick="validarContaPelaAPI()" id="btnValidarConta">3. Validar Conta Via API</button>
    </fieldset>

    <fieldset>
        <legend>Fase 4: Login de Usuário</legend>
        <label for="loginEmail">E-mail de Login</label>
        <input type="email" id="loginEmail" value="joana.dev@email.com">
        <label for="loginSenha">Senha de Login</label>
        <input type="password" id="loginSenha" value="senha_super_segura_123">
        <button onclick="fazerLogin()">4. Fazer Login</button>
    </fieldset>

    <fieldset>
        <legend>Fase 5: Criação de Subgrupo (US1.2)</legend>
        <label for="subgrupoNome">Nome do Novo Subgrupo</label>
        <input type="text" id="subgrupoNome" value="Subgrupo Familiar">
        <label for="subgrupoOrgPaiId">ID da Organização Pai (Opcional)</label>
        <input type="text" id="subgrupoOrgPaiId" placeholder="Deixe em branco para usar a Org Raiz do usuário logado">
        <button onclick="criarSubgrupo()">5. Criar Subgrupo</button>
    </fieldset>

    <fieldset>
        <legend>Testes Adicionais</legend>
        <button onclick="testarPermissaoFalha()" id="btnFalha">Testar Permissão (Deve Falhar se PENDENTE)</button>
        <button onclick="testarPermissaoSucesso()" id="btnSucesso">Testar Permissão (Deve Funcionar)</button>
        <label for="cpfAtualizacao">Novo CPF para Atualização</label>
        <input type="text" id="cpfAtualizacao" value="12345678901">
        <button onclick="atualizarCpfUsuario()">Atualizar CPF (PATCH)</button>
    </fieldset>

    <fieldset>
        <legend>Log de Respostas</legend>
        <pre id="log">Aguardando ações...</pre>
    </fieldset>

    <script>
        const API_URL = 'http://localhost:3333/api/v1'; 
        let state = {
            standbyToken: null,
            loginToken: null,
            userId: null,
            orgId: null, // Para armazenar o ID da organização raiz
            validationLink: null 
        };
        const templates = {
            pessoa: {
                nomeCompleto: "Joana D'Arc Programadora",
                email: "joana.dev@email.com",
                senha: "senha_super_segura_123",
                telefoneCelular: "51911112222",
                dataNascimento: "",
                cpf: "12345678901"
            },
            animal: {
                nome: "Bit", apelido: "Byte", especie: "Cão", raca: "Vira-lata Caramelo", sexo: "Macho", dataNascimento: "2023-01-01", cor: "Caramelo"
            }
        };

        const logEl = document.getElementById('log');
        const standbyTokenEl = document.getElementById('standbyToken');
        const loginTokenEl = document.getElementById('loginToken');
        const userIdEl = document.getElementById('userId');
        const orgIdEl = document.getElementById('orgId'); // Elemento para o ID da organização
        const validationLinkEl = document.getElementById('validationLink');

        const nomeCompletoEl = document.getElementById('nomeCompleto');
        const emailEl = document.getElementById('email');
        const senhaEl = document.getElementById('senha');
        const telefoneCelularEl = document.getElementById('telefoneCelular');
        const dataNascimentoEl = document.getElementById('dataNascimento');
        const cpfEl = document.getElementById('cpf');

        const loginEmailEl = document.getElementById('loginEmail');
        const loginSenhaEl = document.getElementById('loginSenha');

        const subgrupoNomeEl = document.getElementById('subgrupoNome');
        const subgrupoOrgPaiIdEl = document.getElementById('subgrupoOrgPaiId');

        function log(message) {
            logEl.textContent = JSON.stringify(message, null, 2);
            console.log(message);
        }

        function updateStateUI() {
            standbyTokenEl.value = state.standbyToken || '';
            loginTokenEl.value = state.loginToken || '';
            userIdEl.value = state.userId || '';
            orgIdEl.value = state.orgId || ''; // Atualiza o ID da organização na UI
            validationLinkEl.value = state.validationLink || '';
        }

        function toggleInputMode() {
            const isForm = document.querySelector('input[name="inputMode"]:checked').value === 'form';
            document.getElementById('formContainer').style.display = isForm ? 'block' : 'none';
            document.getElementById('jsonContainer').style.display = isForm ? 'none' : 'block';
            if (!isForm) {
                document.getElementById('jsonInput').value = JSON.stringify(templates.pessoa, null, 2);
            }
        }

        async function apiCall(endpoint, method, token = null, body = null, isRawLink = false) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const options = {
                method: method,
                headers: headers
            };
            if (body) {
                options.body = JSON.stringify(body);
            }

            const url = isRawLink ? endpoint : `${API_URL}${endpoint}`;

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                log({ status: response.status, ok: response.ok, body: data });
                return { status: response.status, ok: response.ok, data: data };
            } catch (error) {
                log({ status: 'Network Error ou JSON inválido', message: error.message });
                return { status: 500, ok: false, data: { message: error.message } };
            }
        }

        async function iniciarCadastro() {
            log("Iniciando cadastro para obter Token de Standby...");
            const result = await apiCall('/auth/iniciar-cadastro', 'POST');
            if (result.ok) {
                state.standbyToken = result.data.standby_token;
                updateStateUI();
                log("Token de Standby obtido com sucesso.");
            } else {
                log("Falha ao obter Token de Standby.");
            }
        }

        async function cadastrarUsuario() {
            if (!state.standbyToken) {
                log({ error: 'Primeiro, obtenha o Token de Standby clicando no botão "1. Obter Token de Standby".' });
                return;
            }
            const isForm = document.querySelector('input[name="inputMode"]:checked').value === 'form';
            let dadosUsuario;
            if (isForm) {
                dadosUsuario = {
                    nomeCompleto: nomeCompletoEl.value,
                    email: emailEl.value,
                    senha: senhaEl.value,
                    telefoneCelular: telefoneCelularEl.value,
                    dataNascimento: dataNascimentoEl.value || null,
                    cpf: cpfEl.value || null 
                };
            } else {
                try {
                    dadosUsuario = JSON.parse(document.getElementById('jsonInput').value);
                } catch(e) {
                    log({ error: 'JSON inválido!', details: e.message });
                    return;
                }
            }
            log("Cadastrando usuário com Token de Standby...");
            const result = await apiCall('/pessoas', 'POST', state.standbyToken, dadosUsuario); 

            if (result.ok) {
                state.loginToken = result.data.token || null; 
                state.userId = result.data.pessoa.id;
                state.orgId = result.data.organizacaoRaizId; // <--- FIX: Captura o ID da organização raiz diretamente
                state.validationLink = result.data.linkValidacaoParaTeste; 
                updateStateUI();
                log("Usuário cadastrado com sucesso! Verifique o link de validação.");
                loginEmailEl.value = dadosUsuario.email;
                loginSenhaEl.value = dadosUsuario.senha;
            } else {
                log("Falha ao cadastrar usuário.");
            }
        }

        async function validarContaPelaAPI() {
            if (!state.validationLink) {
                log({ error: 'Cadastre um usuário primeiro para obter o link de validação.' });
                return;
            }
            log(`Validando conta usando o link: ${state.validationLink}`);
            const result = await apiCall(state.validationLink, 'GET', null, null, true); 

            if (result.ok) {
                log("Conta validada com sucesso! Tente testar as permissões novamente.");
            } else {
                log("Falha ao validar conta.");
            }
        }

        async function fazerLogin() {
            const email = loginEmailEl.value;
            const senha = loginSenhaEl.value;

            if (!email || !senha) {
                log({ error: 'Email e senha de login são obrigatórios.' });
                return;
            }
            log(`Tentando login para o email: ${email}...`);
            const result = await apiCall('/auth/login', 'POST', null, { email, senha });

            if (result.ok) {
                state.loginToken = result.data.token;
                state.userId = result.data.user.id;
                updateStateUI();
                log("Login bem-sucedido! Token atualizado.");
            } else {
                log("Falha no login.");
            }
        }

        async function criarSubgrupo() {
            if (!state.loginToken) {
                log({ error: 'Faça o login primeiro para criar um subgrupo.' });
                return;
            }

            const subgrupoNome = subgrupoNomeEl.value;
            let organizacaoPaiId = subgrupoOrgPaiIdEl.value || state.orgId; // Usa o ID da org raiz do estado se não preenchido

            if (!subgrupoNome || !organizacaoPaiId) {
                log({ error: 'Nome do subgrupo e ID da organização pai são obrigatórios.' });
                return;
            }

            log(`Tentando criar subgrupo '${subgrupoNome}' sob organização pai ID: ${organizacaoPaiId}...`);
            const result = await apiCall('/organizacoes', 'POST', state.loginToken, { 
                nome: subgrupoNome, 
                organizacaoPaiId: organizacaoPaiId,
                tipo: 'GRUPO' // Assumimos tipo GRUPO para subgrupos
            });

            if (result.ok) {
                log("Subgrupo criado com sucesso!");
                log(result.data);
            } else {
                log("Falha ao criar subgrupo.");
            }
        }


        async function testarPermissaoFalha() {
            if (!state.loginToken) {
                log({ error: 'Cadastre um usuário e obtenha o Token de Login primeiro.'});
                return;
            }
            log("Tentando criar animal com token de usuário PENDENTE. Esperando erro 403 (ou similar)...");
            await apiCall('/animais', 'POST', state.loginToken, templates.animal);
        }

        async function testarPermissaoSucesso() {
            if (!state.loginToken) {
                log({ error: 'Cadastre e valide um usuário para obter o Token de Login e permissões.'});
                return;
            }
            log("Tentando criar animal com token de usuário ATIVO. Esperando sucesso 201...");
            await apiCall('/animais', 'POST', state.loginToken, templates.animal);
        }

        async function atualizarCpfUsuario() {
            if (!state.loginToken || !state.userId) {
                log({ error: 'Cadastre e logue um usuário para atualizar o CPF.' });
                return;
            }
            const cpfParaAtualizar = cpfEl.value; 

            const userEmail = emailEl.value;

            if (!userEmail) {
                log({ error: 'Email do usuário não disponível no formulário de cadastro para atualização de CPF.' });
                return;
            }

            const body = { email: userEmail, cpf: cpfParaAtualizar };

            log(`Tentando atualizar CPF do usuário ${userEmail} para ${cpfParaAtualizar} via PATCH /pessoas/cpf...`);
            await apiCall(`/pessoas/cpf`, 'PATCH', state.loginToken, body);
        }


        // Funções para geração de dados dinâmicos
        function generateRandomString(length) {
            let result = '';
            const characters = 'abcdefghijklmnopqrstuvwxyz';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        function generateRandomFirstName() {
            const names = ["Maria", "João", "Ana", "Pedro", "Lucas", "Julia", "Fernanda", "Rafael", "Camila", "Bruno"];
            return names[Math.floor(Math.random() * names.length)];
        }

        function generateRandomLastName() {
            const surnames = ["Silva", "Santos", "Oliveira", "Souza", "Pereira", "Lima", "Costa", "Rodrigues", "Almeida", "Nascimento"];
            return surnames[Math.floor(Math.random() * surnames.length)];
        }

        function generateRandomPhoneNumber() {
            const ddd = "51";
            let number = "9"; 
            for (let i = 0; i < 8; i++) {
                number += Math.floor(Math.random() * 10);
            }
            return `+55${ddd}${number}`;
        }

        function generateValidCpf() {
            function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
            function mod(dividend, divisor) { return Math.round(dividend - (Math.floor(dividend / divisor) * divisor)); }
            const n = 9;
            const n1 = rand(0, n), n2 = rand(0, n), n3 = rand(0, n), n4 = rand(0, n), n5 = rand(0, n), n6 = rand(0, n), n7 = rand(0, n), n8 = rand(0, n), n9 = rand(0, n);
            let d1 = n9 * 2 + n8 * 3 + n7 * 4 + n6 * 5 + n5 * 6 + n4 * 7 + n3 * 8 + n2 * 9 + n1 * 10;
            d1 = 11 - (mod(d1, 11));
            if (d1 >= 10) d1 = 0;
            let d2 = d1 * 2 + n9 * 3 + n8 * 4 + n7 * 5 + n6 * 6 + n5 * 7 + n4 * 8 + n3 * 9 + n2 * 10 + n1 * 11;
            d2 = 11 - (mod(d2, 11));
            if (d2 >= 10) d2 = 0;
            return `${n1}${n2}${n3}${n4}${n5}${n6}${n7}${n8}${n9}${d1}${d2}`;
        }

        function generateRandomData() {
            const firstName = generateRandomFirstName();
            const lastName = generateRandomLastName();
            const fullName = `${firstName} ${lastName}`;
            const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@postodeenfermagem.com.br`;
            const phone = generateRandomPhoneNumber();
            const cpf = generateValidCpf();

            nomeCompletoEl.value = fullName;
            emailEl.value = email;
            telefoneCelularEl.value = phone;
            cpfEl.value = cpf;

            log("Dados aleatórios gerados no formulário.");
            loginEmailEl.value = email;
            loginSenhaEl.value = templates.pessoa.senha;
        }


        // Inicializa a UI
        toggleInputMode();
        updateStateUI(); 
        generateRandomData(); 
    </script>
</body>
</html>