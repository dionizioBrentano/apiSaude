<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bancada de Testes da API</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 900px; margin: auto; background-color: #f4f7f9; }
        h1, h2, h3 { color: #333; }
        fieldset { border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; padding: 20px; background-color: white; }
        legend { font-weight: bold; font-size: 1.2em; padding: 0 10px; color: #007bff; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], textarea { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        textarea { height: 150px; font-family: monospace; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; padding: 12px 18px; border-radius: 4px; font-size: 1em; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #log { background-color: #2d333b; color: #adbac7; border-radius: 4px; padding: 15px; white-space: pre-wrap; font-family: monospace; min-height: 100px; }
        .state-display { display: flex; gap: 20px; margin-bottom: 20px; }
        .state-display div { flex: 1; }
        .state-display input { background-color: #e9ecef; }
        .input-mode { margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Bancada de Testes da API</h1>

    <fieldset>
        <legend>Estado Atual</legend>
        <div class="state-display">
            <div>
                <label for="standbyToken">Token de Standby</label>
                <input type="text" id="standbyToken" readonly>
            </div>
            <div>
                <label for="loginToken">Token de Login</label>
                <input type="text" id="loginToken" readonly>
            </div>
            <div>
                <label for="userId">ID do Usuário Criado</label>
                <input type="text" id="userId" readonly>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>Fase 1 & 2: Cadastrar Usuário</legend>
        <div class="input-mode">
            <label><input type="radio" name="inputMode" value="form" checked onchange="toggleInputMode()"> Formulário</label>
            <label><input type="radio" name="inputMode" value="json" onchange="toggleInputMode()"> JSON Bruto</label>
        </div>
        <div id="formContainer">
            <label for="nomeCompleto">Nome Completo</label>
            <input type="text" id="nomeCompleto" value="Joana D'Arc Programadora">
            <label for="email">E-mail</label>
            <input type="email" id="email" value="joana.dev@email.com">
            <label for="senha">Senha</label>
            <input type="password" id="senha" value="senha_super_segura_123">
            <label for="telefoneCelular">Telefone Celular</label>
            <input type="text" id="telefoneCelular" value="51911112222">
            <label for="dataNascimento">Data de Nascimento</label>
            <input type="date" id="dataNascimento" value="1990-01-01">
            <label for="cpf">CPF (opcional)</label>
            <input type="text" id="cpf" value="12345678901">
        </div>
        <div id="jsonContainer" style="display: none;">
            <textarea id="jsonInput"></textarea>
        </div>
        <button onclick="iniciarCadastro()">1. Obter Token de Standby</button>
        <button onclick="cadastrarUsuario()" id="btnCadastrar">2. Cadastrar Usuário</button>
    </fieldset>

    <fieldset>
        <legend>Fase 3, 4 & 5: Permissões e Ativação</legend>
        <button onclick="testarPermissaoFalha()" id="btnFalha">3. Testar Permissão (Deve Falhar)</button>
        <button onclick="ativarConta()" id="btnAtivar">4. Ativar Conta</button>
        <button onclick="testarPermissaoSucesso()" id="btnSucesso">5. Testar Permissão (Deve Funcionar)</button>
    </fieldset>

    <fieldset>
        <legend>Log de Respostas</legend>
        <pre id="log">Aguardando ações...</pre>
    </fieldset>

    <script>
        const API_URL = 'http://localhost:3333/api/v1';
        let state = {
            standbyToken: null,
            loginToken: null,
            userId: null
        };
        const templates = {
            pessoa: {
                nomeCompleto: "Joana D'Arc Programadora",
                email: "joana.dev@email.com",
                senha: "senha_super_segura_123",
                telefoneCelular: "51911112222",
                dataNascimento: "1990-01-01",
                cpf: "12345678901"
            },
            animal: {
                nome: "Bit",
                apelido: "Byte",
                especie: "Cão",
                raca: "Vira-lata Caramelo",
                sexo: "Macho",
                dataNascimento: "2023-01-01",
                cor: "Caramelo"
            }
        };

        const logEl = document.getElementById('log');
        const standbyTokenEl = document.getElementById('standbyToken');
        const loginTokenEl = document.getElementById('loginToken');
        const userIdEl = document.getElementById('userId');

        function log(message) {
            logEl.textContent = JSON.stringify(message, null, 2);
            console.log(message);
        }

        function updateStateUI() {
            standbyTokenEl.value = state.standbyToken || '';
            loginTokenEl.value = state.loginToken || '';
            userIdEl.value = state.userId || '';
        }

        function toggleInputMode() {
            const isForm = document.querySelector('input[name="inputMode"]:checked').value === 'form';
            document.getElementById('formContainer').style.display = isForm ? 'block' : 'none';
            document.getElementById('jsonContainer').style.display = isForm ? 'none' : 'block';
            if (!isForm) {
                document.getElementById('jsonInput').value = JSON.stringify(templates.pessoa, null, 2);
            }
        }

        async function apiCall(endpoint, method, token = null, body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const options = {
                method: method,
                headers: headers
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(`${API_URL}${endpoint}`, options);
            const data = await response.json();
            log({ status: response.status, ok: response.ok, body: data });
            return { ok: response.ok, data: data };
        }

        async function iniciarCadastro() {
            const result = await apiCall('/auth/iniciar-cadastro', 'POST');
            if (result.ok) {
                state.standbyToken = result.data.standby_token;
                updateStateUI();
            }
        }

        async function cadastrarUsuario() {
            if (!state.standbyToken) {
                log({ error: 'Primeiro, obtenha o Token de Standby clicando no botão 1.' });
                return;
            }
            const isForm = document.querySelector('input[name="inputMode"]:checked').value === 'form';
            let dadosUsuario;
            if (isForm) {
                dadosUsuario = {
                    nomeCompleto: document.getElementById('nomeCompleto').value,
                    email: document.getElementById('email').value,
                    senha: document.getElementById('senha').value,
                    telefoneCelular: document.getElementById('telefoneCelular').value,
                    dataNascimento: document.getElementById('dataNascimento').value,
                    cpf: document.getElementById('cpf').value || null
                };
            } else {
                try {
                    dadosUsuario = JSON.parse(document.getElementById('jsonInput').value);
                } catch(e) {
                    log({ error: 'JSON inválido!', details: e.message });
                    return;
                }
            }
            const result = await apiCall('/pessoas', 'POST', state.standbyToken, dadosUsuario);
            if (result.ok) {
                state.loginToken = result.data.token;
                state.userId = result.data.user.id;
                updateStateUI();
            }
        }

        async function testarPermissaoFalha() {
            if (!state.loginToken) {
                log({ error: 'Cadastre um usuário e obtenha o Token de Login primeiro.'});
                return;
            }
            document.getElementById('jsonInput').value = JSON.stringify(templates.animal, null, 2);
            log("Tentando criar animal com token de usuário PENDENTE. Esperando erro 403...");
            await apiCall('/animais', 'POST', state.loginToken, templates.animal);
        }

        async function ativarConta() {
            if (!state.loginToken || !state.userId) {
                log({ error: 'Cadastre um usuário para obter ID e Token de Login primeiro.'});
                return;
            }
            log(`Ativando conta do usuário ${state.userId}...`);
            await apiCall(`/pessoas/${state.userId}/ativar`, 'POST', state.loginToken);
        }

        async function testarPermissaoSucesso() {
             if (!state.loginToken) {
                log({ error: 'Cadastre um usuário e obtenha o Token de Login primeiro.'});
                return;
            }
            document.getElementById('jsonInput').value = JSON.stringify(templates.animal, null, 2);
            log("Tentando criar animal com token de usuário ATIVO. Esperando sucesso 201...");
            await apiCall('/animais', 'POST', state.loginToken, templates.animal);
        }

        // Inicializa a UI
        toggleInputMode();
    </script>
</body>
</html>